# ç”¨æˆ·åˆ—è¡¨åˆ·æ–°åŠŸèƒ½ - å®Œæ•´ä¿®å¤è¯´æ˜

## ğŸ”§ ä¿®å¤å†…å®¹

### é—®é¢˜æè¿°
- åŸé—®é¢˜ï¼šç‚¹å‡»åˆ·æ–°æŒ‰é’®åï¼Œç”¨æˆ·åˆ—è¡¨ä¸ä¼šæ›´æ–°ï¼Œå¿…é¡»é€€å‡ºé‡è¿›æ‰èƒ½çœ‹åˆ°æ–°ç”¨æˆ·
- æ ¹æœ¬åŸå› ï¼šåˆ·æ–°æ—¶æ²¡æœ‰æ¸…ç©ºæ—§åˆ—è¡¨ï¼Œä¸”å¹¿æ’­æœºåˆ¶ä¸å®Œæ•´

### å®Œæ•´è§£å†³æ–¹æ¡ˆ

#### 1. åˆ·æ–°æµç¨‹ï¼ˆä¸‰ç®¡é½ä¸‹ï¼‰

ç‚¹å‡»"ğŸ”„ åˆ·æ–°æˆå‘˜åˆ—è¡¨"æŒ‰é’®åï¼š

```
ç¬¬ä¸€æ­¥ï¼šæ¸…ç©ºç°æœ‰æˆå‘˜åˆ—è¡¨
â””â”€> member_manager.clear_members()

ç¬¬äºŒæ­¥ï¼šå‘é€ä¸‰ç§å¹¿æ’­ï¼ˆç¡®ä¿å‘ç°æ‰€æœ‰æˆå‘˜ï¼‰
â”œâ”€> REFRESH å¹¿æ’­ï¼šé€šçŸ¥å…¶ä»–å®¢æˆ·ç«¯å“åº”
â”œâ”€> DISCOVERY å¹¿æ’­ï¼šä¸»åŠ¨å‘ç°å…¶ä»–å®¢æˆ·ç«¯  
â””â”€> JOIN å¹¿æ’­ï¼šé‡æ–°å¹¿æ’­è‡ªå·±çš„å­˜åœ¨

ç¬¬ä¸‰æ­¥ï¼šç­‰å¾…å“åº”å¹¶é‡å»ºåˆ—è¡¨
â”œâ”€> å…¶ä»–å®¢æˆ·ç«¯æ”¶åˆ°è¯·æ±‚åå›å¤
â”œâ”€> æœ¬åœ°æ¥æ”¶å“åº”å¹¶æ·»åŠ æˆå‘˜
â””â”€> 2ç§’åæ˜¾ç¤ºåˆ·æ–°ç»“æœ
```

#### 2. ä»£ç ä¿®æ”¹

**æ–‡ä»¶1: src/ui/main_window.py**
```python
def on_refresh_members(self):
    """åˆ·æ–°æˆå‘˜åˆ—è¡¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶"""
    if self.member_refresh and self.member_manager:
        # 1. æ¸…ç©ºç°æœ‰æˆå‘˜åˆ—è¡¨
        self.member_manager.clear_members()
        print("[UI] å·²æ¸…ç©ºæˆå‘˜åˆ—è¡¨")
        
        # 2. æ›´æ–°çŠ¶æ€æ æç¤º
        self.statusBar().showMessage('æ­£åœ¨åˆ·æ–°æˆå‘˜åˆ—è¡¨...')
        
        # 3. å‘é€åˆ·æ–°å¹¿æ’­
        self.member_refresh.refresh_members()
        
        # 4. 2ç§’åæ˜¾ç¤ºåˆ·æ–°å®Œæˆåé¦ˆ
        if self.refresh_feedback_timer:
            self.refresh_feedback_timer.stop()
        self.refresh_feedback_timer = QTimer()
        self.refresh_feedback_timer.setSingleShot(True)
        self.refresh_feedback_timer.timeout.connect(self._on_refresh_completed)
        self.refresh_feedback_timer.start(2000)

def _on_refresh_completed(self):
    """åˆ·æ–°å®Œæˆåçš„åé¦ˆ"""
    member_count = len(self.member_manager.get_member_list()) if self.member_manager else 0
    self.statusBar().showMessage(f'åˆ·æ–°å®Œæˆï¼Œå‘ç° {member_count} ä¸ªåœ¨çº¿æˆå‘˜', 3000)
    print(f"[UI] åˆ·æ–°å®Œæˆï¼Œå½“å‰æˆå‘˜æ•°: {member_count}")
```

**æ–‡ä»¶2: src/core/member_refresh.py**
```python
def refresh_members(self):
    """æ‰‹åŠ¨åˆ·æ–°æˆå‘˜åˆ—è¡¨"""
    try:
        self.is_refreshing = True
        self.refresh_started.emit()
        
        # æ–¹æ³•1: å‘é€REFRESHå¹¿æ’­
        refresh_msg = ChatMessage(
            msg_type=MessageType.REFRESH,
            sender=self.local_member,
            content=REFRESH_KEYWORD
        )
        self.dispatcher.broadcast_udp(refresh_msg.to_dict())
        
        # æ–¹æ³•2: å‘é€DISCOVERYå¹¿æ’­
        discovery_msg = ChatMessage(
            msg_type=MessageType.DISCOVERY,
            sender=self.local_member,
            content=DISCOVERY_KEYWORD
        )
        self.dispatcher.broadcast_udp(discovery_msg.to_dict())
        
        # æ–¹æ³•3: é‡æ–°å¹¿æ’­JOINæ¶ˆæ¯
        join_msg = ChatMessage(
            msg_type=MessageType.JOIN,
            sender=self.local_member,
            content="JOIN"
        )
        self.dispatcher.broadcast_udp(join_msg.to_dict())
        
    except Exception as e:
        print(f"åˆ·æ–°æˆå‘˜åˆ—è¡¨å¤±è´¥: {e}")
        self.is_refreshing = False

def handle_refresh_message(self, message: dict, addr: tuple):
    """å¤„ç†åˆ·æ–°æ¶ˆæ¯"""
    if msg_type == MessageType.REFRESH.value:
        # æ”¶åˆ°åˆ·æ–°è¯·æ±‚ï¼Œè¿”å›å“åº”
        response = ChatMessage(
            msg_type=MessageType.DISCOVERY_RESPONSE,
            sender=self.local_member,
            content="REFRESH_RESPONSE"
        )
        self.dispatcher.send_message(response.to_dict(), addr[0], addr[1])
        
        # åŒæ—¶é‡æ–°å¹¿æ’­JOIN
        join_msg = ChatMessage(
            msg_type=MessageType.JOIN,
            sender=self.local_member,
            content="JOIN"
        )
        self.dispatcher.broadcast_udp(join_msg.to_dict())
```

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æµ‹è¯•åœºæ™¯1ï¼šåŸºæœ¬åˆ·æ–°
1. å¯åŠ¨å®¢æˆ·ç«¯A
2. å¯åŠ¨å®¢æˆ·ç«¯B
3. åœ¨Aä¸­ç‚¹å‡»"åˆ·æ–°æˆå‘˜åˆ—è¡¨"
4. **é¢„æœŸç»“æœ**ï¼š
   - Açš„åˆ—è¡¨ä¸­å‡ºç°B
   - çŠ¶æ€æ æ˜¾ç¤º"æ­£åœ¨åˆ·æ–°..."
   - 2ç§’åæ˜¾ç¤º"åˆ·æ–°å®Œæˆï¼Œå‘ç°1ä¸ªåœ¨çº¿æˆå‘˜"

### æµ‹è¯•åœºæ™¯2ï¼šæ–°æˆå‘˜åŠ å…¥ååˆ·æ–°
1. å®¢æˆ·ç«¯Aå’ŒBå·²åœ¨çº¿
2. å¯åŠ¨æ–°å®¢æˆ·ç«¯C
3. åœ¨Aä¸­ç‚¹å‡»"åˆ·æ–°æˆå‘˜åˆ—è¡¨"
4. **é¢„æœŸç»“æœ**ï¼š
   - Açš„åˆ—è¡¨æ˜¾ç¤ºBå’ŒC
   - çŠ¶æ€æ æ˜¾ç¤º"å‘ç°2ä¸ªåœ¨çº¿æˆå‘˜"

### æµ‹è¯•åœºæ™¯3ï¼šæˆå‘˜ç¦»å¼€ååˆ·æ–°
1. å®¢æˆ·ç«¯Aã€Bã€Céƒ½åœ¨çº¿
2. å…³é—­å®¢æˆ·ç«¯C
3. åœ¨Aä¸­ç‚¹å‡»"åˆ·æ–°æˆå‘˜åˆ—è¡¨"
4. **é¢„æœŸç»“æœ**ï¼š
   - Açš„åˆ—è¡¨åªæ˜¾ç¤ºB
   - Cä»åˆ—è¡¨ä¸­æ¶ˆå¤±
   - çŠ¶æ€æ æ˜¾ç¤º"å‘ç°1ä¸ªåœ¨çº¿æˆå‘˜"

## ğŸ“Š è°ƒè¯•ä¿¡æ¯

è¿è¡Œç¨‹åºæ—¶ï¼Œæ§åˆ¶å°ä¼šæ˜¾ç¤ºè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼š

```
[UI] å·²æ¸…ç©ºæˆå‘˜åˆ—è¡¨
[åˆ·æ–°] å¼€å§‹åˆ·æ–°æˆå‘˜åˆ—è¡¨
[åˆ·æ–°] å·²å‘é€REFRESHå¹¿æ’­
[åˆ·æ–°] å·²å‘é€DISCOVERYå¹¿æ’­
[åˆ·æ–°] å·²é‡æ–°å¹¿æ’­JOINæ¶ˆæ¯
[åˆ·æ–°] æ”¶åˆ°å“åº”ï¼Œå½“å‰å·²å‘ç° 1 ä¸ªæˆå‘˜
[UI] åˆ·æ–°å®Œæˆï¼Œå½“å‰æˆå‘˜æ•°: 1
```

## âš™ï¸ æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆä½¿ç”¨ä¸‰ç§å¹¿æ’­ï¼Ÿ

1. **REFRESHå¹¿æ’­**
   - ä¸»åŠ¨é€šçŸ¥å…¶ä»–å®¢æˆ·ç«¯"æˆ‘è¦åˆ·æ–°äº†ï¼Œè¯·å›åº”"
   - å…¶ä»–å®¢æˆ·ç«¯æ”¶åˆ°åä¼šå›å¤DISCOVERY_RESPONSE

2. **DISCOVERYå¹¿æ’­**
   - æ ‡å‡†çš„å‘ç°æœºåˆ¶
   - ç”¨äºå‘ç°å¯èƒ½æ²¡æœ‰å“åº”REFRESHçš„å®¢æˆ·ç«¯

3. **JOINå¹¿æ’­**
   - é‡æ–°å¹¿æ’­è‡ªå·±çš„å­˜åœ¨
   - è®©å…¶ä»–å®¢æˆ·ç«¯çŸ¥é“"æˆ‘è¿˜åœ¨çº¿"
   - è§¦å‘å…¶ä»–å®¢æˆ·ç«¯çš„JOINå¤„ç†é€»è¾‘

### ä¸ºä»€ä¹ˆè¦æ¸…ç©ºåˆ—è¡¨ï¼Ÿ

- æ—§æ–¹æ³•ï¼šåˆ·æ–°æ—¶ä¿ç•™æ—§åˆ—è¡¨ï¼Œåªæ·»åŠ æ–°æˆå‘˜
  - é—®é¢˜ï¼šç¦»çº¿çš„æˆå‘˜ä»ç„¶åœ¨åˆ—è¡¨ä¸­
  - é—®é¢˜ï¼š`add_member`ä¼šè·³è¿‡å·²å­˜åœ¨çš„æˆå‘˜

- æ–°æ–¹æ³•ï¼šæ¸…ç©ºåé‡å»º
  - ä¼˜ç‚¹ï¼šåˆ—è¡¨å§‹ç»ˆåæ˜ å½“å‰åœ¨çº¿çŠ¶æ€
  - ä¼˜ç‚¹ï¼šæ¯æ¬¡åˆ·æ–°éƒ½æ˜¯å®Œæ•´çš„çŠ¶æ€æ›´æ–°

## ğŸ¯ ä½¿ç”¨è¯´æ˜

### ä½•æ—¶ä½¿ç”¨åˆ·æ–°ï¼Ÿ

âœ“ **åº”è¯¥åˆ·æ–°çš„æƒ…å†µï¼š**
- æœ‰æ–°ç”¨æˆ·åŠ å…¥ä½†åˆ—è¡¨æ²¡æ›´æ–°
- åˆ—è¡¨ä¸­æœ‰ç¦»çº¿ç”¨æˆ·
- é•¿æ—¶é—´è¿è¡Œåæƒ³ç¡®è®¤åœ¨çº¿çŠ¶æ€
- ç½‘ç»œæ³¢åŠ¨åé‡æ–°å‘ç°æˆå‘˜

âœ— **ä¸éœ€è¦åˆ·æ–°çš„æƒ…å†µï¼š**
- åˆšå¯åŠ¨ç¨‹åºï¼ˆè‡ªåŠ¨å‘ç°ï¼‰
- åˆ—è¡¨å·²ç»æ­£ç¡®æ˜¾ç¤ºæ‰€æœ‰åœ¨çº¿æˆå‘˜

### åˆ·æ–°é¢‘ç‡

- å»ºè®®ï¼šéœ€è¦æ—¶æ‰‹åŠ¨åˆ·æ–°
- ä¸å»ºè®®ï¼šé¢‘ç¹åˆ·æ–°ï¼ˆæ¯æ¬¡åˆ·æ–°ä¼šäº§ç”Ÿç½‘ç»œæµé‡ï¼‰
- æç¤ºï¼šçŠ¶æ€æ ä¼šæ˜¾ç¤ºåˆ·æ–°ç»“æœ

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šåˆ·æ–°ååˆ—è¡¨ä»ç„¶ä¸ºç©º
**å¯èƒ½åŸå› ï¼š**
- ç½‘ç»œé—®é¢˜ï¼Œå¹¿æ’­æ²¡æœ‰å‘é€æˆåŠŸ
- é˜²ç«å¢™é˜»æ­¢äº†UDPç«¯å£9999
- å…¶ä»–å®¢æˆ·ç«¯æ²¡æœ‰æ­£å¸¸å“åº”

**è§£å†³æ–¹æ³•ï¼š**
1. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
2. ç¡®ä¿åœ¨åŒä¸€å±€åŸŸç½‘
3. æŸ¥çœ‹æ§åˆ¶å°è°ƒè¯•ä¿¡æ¯

### é—®é¢˜2ï¼šåˆ·æ–°ååªæ˜¾ç¤ºéƒ¨åˆ†æˆå‘˜
**å¯èƒ½åŸå› ï¼š**
- éƒ¨åˆ†å®¢æˆ·ç«¯ç½‘ç»œå»¶è¿Ÿ
- 2ç§’è¶…æ—¶æ—¶é—´å¤ªçŸ­

**è§£å†³æ–¹æ³•ï¼š**
- ç­‰å¾…å‡ ç§’åå†æ¬¡åˆ·æ–°
- æˆ–ä¿®æ”¹å®šæ—¶å™¨æ—¶é—´ï¼ˆå¢åŠ åˆ°3-5ç§’ï¼‰

### é—®é¢˜3ï¼šåˆ·æ–°æŒ‰é’®æ— å“åº”
**å¯èƒ½åŸå› ï¼š**
- ç¨‹åºæ­£åœ¨åˆ·æ–°ä¸­ï¼ˆé˜²æ­¢é‡å¤åˆ·æ–°ï¼‰
- ä»£ç é”™è¯¯

**è§£å†³æ–¹æ³•ï¼š**
- ç­‰å¾…å½“å‰åˆ·æ–°å®Œæˆ
- æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯

## ğŸ“ ç‰ˆæœ¬ä¿¡æ¯

- **ä¿®å¤ç‰ˆæœ¬**: 2.0
- **ä¿®å¤æ—¥æœŸ**: 2025å¹´12æœˆ20æ—¥
- **æŠ€æœ¯æ ˆ**: Python 3.12 + PyQt5
- **æ‰“åŒ…å·¥å…·**: PyInstaller 6.17.0

## ğŸ‰ æ€»ç»“

ç°åœ¨çš„åˆ·æ–°åŠŸèƒ½ï¼š
- âœ… çœŸæ­£æ¸…ç©ºå¹¶é‡å»ºåˆ—è¡¨
- âœ… ä½¿ç”¨ä¸‰ç§å¹¿æ’­ç¡®ä¿å‘ç°æ‰€æœ‰æˆå‘˜
- âœ… æä¾›æ¸…æ™°çš„çŠ¶æ€åé¦ˆ
- âœ… åŒ…å«è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- âœ… å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ

**ç°åœ¨ç‚¹å‡»åˆ·æ–°æŒ‰é’®åº”è¯¥å®Œå…¨æ­£å¸¸å·¥ä½œäº†ï¼**



