# æ¶æ„ä¼˜åŒ–åçš„æˆå‘˜ä»»åŠ¡åˆ†é…

## ğŸ¯ æ ¸å¿ƒå˜åŒ–

å¼•å…¥äº† **MessageDispatcherï¼ˆæ¶ˆæ¯åˆ†å‘å™¨ï¼‰** ç»Ÿä¸€ç®¡ç†UDPé€šä¿¡ï¼Œå„æ¨¡å—èŒè´£æ›´åŠ æ¸…æ™°ã€‚

---

## ğŸ“‹ æˆå‘˜ä»»åŠ¡è¯¦ç»†è¯´æ˜

### æˆå‘˜ä¸€ï¼šæç‰§ç†¹ - æ¶ˆæ¯åˆ†å‘å™¨ + ç½‘ç»œå‘ç°

#### ä»»åŠ¡1ï¼šMessageDispatcherï¼ˆä¸æˆå‘˜ä¸ƒåä½œï¼‰â­â­â­â­

**æ–‡ä»¶**ï¼š`src/core/message_dispatcher.py`

**éœ€è¦å®ç°**ï¼š
- âœ… `start()` - å·²å®ç°æ¡†æ¶
- âœ… `stop()` - å·²å®ç°æ¡†æ¶
- âœ… `_listen_loop()` - å·²å®ç°æ¡†æ¶
- æ— éœ€é¢å¤–å®ç°ï¼Œå¯ç›´æ¥æµ‹è¯•

**æµ‹è¯•é‡ç‚¹**ï¼š
```python
# æµ‹è¯•UDP socketåˆ›å»º
# æµ‹è¯•æ¶ˆæ¯æ¥æ”¶
# æµ‹è¯•æ¶ˆæ¯åˆ†å‘åˆ°ä¸åŒä¿¡å·
```

#### ä»»åŠ¡2ï¼šNetworkDiscoveryï¼ˆç®€åŒ–ç‰ˆï¼‰â­â­

**æ–‡ä»¶**ï¼š`src/core/network_discovery.py`

**éœ€è¦å®ç°çš„å‡½æ•°**ï¼š
1. `send_discovery_broadcast()`
   ```python
   # æ„é€ DISCOVERYæ¶ˆæ¯
   message = ChatMessage(
       msg_type=MessageType.DISCOVERY,
       sender=self.local_member,
       content=DISCOVERY_KEYWORD
   )
   # ä½¿ç”¨dispatcherå¹¿æ’­
   self.dispatcher.broadcast_message(message.to_dict())
   ```

2. `handle_message(message, addr)`
   ```python
   # åˆ¤æ–­æ¶ˆæ¯ç±»å‹å¹¶åˆ†å‘
   if msg_type == DISCOVERY:
       _handle_discovery_request()
   elif msg_type == DISCOVERY_RESPONSE:
       _handle_discovery_response()
   ```

3. `_handle_discovery_request(message, addr)`
   ```python
   # æ„é€ å“åº”æ¶ˆæ¯
   response = ChatMessage(
       msg_type=MessageType.DISCOVERY_RESPONSE,
       sender=self.local_member,
       content="RESPONSE"
   )
   # å‘é€ç»™è¯·æ±‚è€…
   self.dispatcher.send_message(response.to_dict(), addr[0], addr[1])
   ```

4. `_handle_discovery_response(message, addr)`
   ```python
   # æå–æˆå‘˜ä¿¡æ¯
   member = Member.from_dict(message['sender'])
   # è§¦å‘ä¿¡å·
   self.member_discovered.emit(member)
   ```

---

### æˆå‘˜äºŒï¼šé©¬é©°åŸ - ç•Œé¢æ•´åˆä¸è®¾è®¡ â­â­â­â­â­

**æ–‡ä»¶**ï¼š`src/ui/main_window.py`

**éœ€è¦å®ç°çš„å…³é”®å‡½æ•°**ï¼š

#### 1. `init_modules()`
```python
def init_modules(self):
    # è·å–ç”¨æˆ·å
    from ..main import get_username
    username = get_username()
    
    # åˆ›å»ºæœ¬åœ°æˆå‘˜å¯¹è±¡
    local_ip = get_local_ip()
    self.local_member = Member(
        username=username,
        ip=local_ip,
        udp_port=DEFAULT_UDP_PORT,
        tcp_port=DEFAULT_TCP_PORT
    )
    
    # æ›´æ–°UIæ˜¾ç¤º
    self.label_username.setText(f"ç”¨æˆ·åï¼š{username}")
    self.label_ip.setText(f"IPï¼š{local_ip}")
    
    # *** æ ¸å¿ƒï¼šæŒ‰é¡ºåºåˆ›å»ºæ¨¡å— ***
    
    # 1. åˆ›å»ºæ¶ˆæ¯åˆ†å‘å™¨ï¼ˆæœ€å…ˆï¼‰
    self.message_dispatcher = MessageDispatcher(self.local_member)
    self.message_dispatcher.start()
    
    # 2. åˆ›å»ºå„åŠŸèƒ½æ¨¡å—ï¼ˆä¼ å…¥dispatcherï¼‰
    self.network_discovery = NetworkDiscovery(
        self.local_member, self.message_dispatcher)
    self.message_p2p = MessageP2P(
        self.local_member, self.message_dispatcher)
    self.message_broadcast = MessageBroadcast(
        self.local_member, self.message_dispatcher)
    self.member_manager = MemberManager(
        self.local_member, self.message_dispatcher)
    self.member_refresh = MemberRefresh(
        self.local_member, self.message_dispatcher)
    self.file_transfer = FileTransfer(self.local_member)
    self.file_transfer.start()
```

#### 2. `connect_signals()`
```python
def connect_signals(self):
    # *** è¿æ¥dispatcherçš„ä¿¡å·åˆ°å„æ¨¡å— ***
    self.message_dispatcher.discovery_message.connect(
        self.network_discovery.handle_message)
    self.message_dispatcher.p2p_message.connect(
        self.message_p2p.handle_message)
    self.message_dispatcher.broadcast_message.connect(
        self.message_broadcast.handle_message)
    self.message_dispatcher.join_message.connect(
        self.member_manager.handle_join_message)
    self.message_dispatcher.leave_message.connect(
        self.member_manager.handle_leave_message)
    self.message_dispatcher.refresh_message.connect(
        self.member_refresh.handle_refresh_message)
    
    # *** è¿æ¥å„æ¨¡å—çš„ä¿¡å·åˆ°UIæ§½å‡½æ•° ***
    self.network_discovery.member_discovered.connect(
        self.on_member_discovered)
    self.message_p2p.message_received.connect(
        self.on_message_received)
    self.message_broadcast.broadcast_received.connect(
        self.on_broadcast_received)
    self.file_transfer.file_request_received.connect(
        self.on_file_request)
    self.file_transfer.transfer_progress.connect(
        self.on_transfer_progress)
    self.member_manager.member_list_updated.connect(
        self.on_member_list_updated)
    
    # *** æˆå‘˜åˆ—è¡¨åŒæ­¥åˆ°å¹¿æ’­æ¨¡å— ***
    self.member_manager.member_list_updated.connect(
        self.message_broadcast.update_member_list)
    
    # å‘é€åˆå§‹å‘ç°å¹¿æ’­
    self.network_discovery.send_discovery_broadcast()
```

#### 3. å®ç°æ‰€æœ‰æ§½å‡½æ•°
- `on_refresh_members()` - è°ƒç”¨ `member_refresh.refresh_members()`
- `on_send_message()` - è°ƒç”¨ `message_p2p.send_p2p_message()`
- `on_broadcast_message()` - è°ƒç”¨ `message_broadcast.send_broadcast_message()`
- `on_send_file()` - è°ƒç”¨ `file_transfer.send_file()`
- `on_member_discovered()` - è°ƒç”¨ `member_manager.add_member()`
- `on_message_received()` - æ˜¾ç¤ºæ¶ˆæ¯
- `on_member_list_updated()` - æ›´æ–°UIåˆ—è¡¨

**åä½œé‡ç‚¹**ï¼š
- ä¸æˆå‘˜ä¸€ä¸€èµ·å®Œæˆ MessageDispatcher çš„æµ‹è¯•
- åè°ƒå„æ¨¡å—çš„ä¿¡å·è¿æ¥
- ç¡®ä¿UIå“åº”æµç•…

---

### æˆå‘˜ä¸‰ï¼šå­Ÿä¿Šå®‡ - å¹¿æ’­æ¶ˆæ¯ â­â­

**æ–‡ä»¶**ï¼š`src/core/message_broadcast.py`

**éœ€è¦å®ç°çš„å‡½æ•°**ï¼š
1. `send_broadcast_message(content)`
   ```python
   message = ChatMessage(
       msg_type=MessageType.BROADCAST_MESSAGE,
       sender=self.local_member,
       content=content
   )
   message_dict = message.to_dict()
   
   # å‘æ¯ä¸ªæˆå‘˜å‘é€
   for member in self.member_list:
       self.dispatcher.send_message(
           message_dict,
           member.ip,
           member.udp_port
       )
   ```

2. `handle_message(message, addr)`
   ```python
   chat_message = ChatMessage.from_dict(message)
   self.broadcast_received.emit(chat_message)
   ```

**æ³¨æ„**ï¼šéœ€è¦ä» `member_manager` è·å–æœ€æ–°çš„æˆå‘˜åˆ—è¡¨

---

### æˆå‘˜å››ï¼šä½•å‡† - æ–‡ä»¶ä¼ è¾“ â­â­â­â­

**æ–‡ä»¶**ï¼š`src/core/file_transfer.py`

**æ— éœ€ä¿®æ”¹æ¶æ„**ï¼ŒTCPç‹¬ç«‹å·¥ä½œã€‚

**éœ€è¦å®ç°çš„å‡½æ•°**ï¼š
1. `start()` - å¯åŠ¨TCPç›‘å¬
2. `_send_file_thread()` - å‘é€æ–‡ä»¶
3. `_handle_client()` - æ¥æ”¶æ–‡ä»¶
4. è¿›åº¦æ›´æ–° `transfer_progress.emit()`

**æç¤º**ï¼š
- æ–‡ä»¶ä¿¡æ¯å‘é€ï¼šæ–‡ä»¶åã€å¤§å°
- åˆ†å—ä¼ è¾“ï¼šæ¯å— 8192 å­—èŠ‚
- è¿›åº¦è®¡ç®—ï¼š`(sent / total) * 100`

---

### æˆå‘˜äº”ï¼šåˆ˜æ³½æ¥· - ç»„å‘˜ç®¡ç† â­â­â­

**æ–‡ä»¶**ï¼š`src/core/member_manager.py`

**éœ€è¦å®ç°çš„å‡½æ•°**ï¼š
1. `add_member(member)`
   ```python
   # æ£€æŸ¥é‡å¤å’Œæœ¬åœ°ç”¨æˆ·
   if member in self.members or member == self.local_member:
       return
   
   self.members.append(member)
   self.member_added.emit(member)
   self.member_list_updated.emit(self.members.copy())
   ```

2. `remove_member(member)`
   ```python
   if member in self.members:
       self.members.remove(member)
       self.member_removed.emit(member)
       self.member_list_updated.emit(self.members.copy())
   ```

3. `broadcast_join()`
   ```python
   message = ChatMessage(
       msg_type=MessageType.JOIN,
       sender=self.local_member,
       content="JOIN"
   )
   self.dispatcher.broadcast_message(message.to_dict())
   ```

4. `broadcast_leave()`
   ```python
   message = ChatMessage(
       msg_type=MessageType.LEAVE,
       sender=self.local_member,
       content="LEAVE"
   )
   self.dispatcher.broadcast_message(message.to_dict())
   ```

5. `handle_join_message(message, addr)`
   ```python
   member = Member.from_dict(message['sender'])
   self.add_member(member)
   ```

6. `handle_leave_message(message, addr)`
   ```python
   member = Member.from_dict(message['sender'])
   self.remove_member(member)
   ```

---

### æˆå‘˜å…­ï¼šçŸ³æ˜ç¦ - æ‰‹åŠ¨åˆ·æ–° â­â­

**æ–‡ä»¶**ï¼š`src/core/member_refresh.py`

**éœ€è¦å®ç°çš„å‡½æ•°**ï¼š
1. `refresh_members()`
   ```python
   self.is_refreshing = True
   self.refresh_started.emit()
   
   message = ChatMessage(
       msg_type=MessageType.REFRESH,
       sender=self.local_member,
       content=REFRESH_KEYWORD
   )
   self.dispatcher.broadcast_message(message.to_dict())
   
   # å¯é€‰ï¼š3ç§’åè§¦å‘å®Œæˆ
   QTimer.singleShot(3000, lambda: self._on_refresh_timeout())
   ```

2. `handle_refresh_message(message, addr)`
   ```python
   # æ”¶åˆ°åˆ·æ–°è¯·æ±‚ï¼Œè¿”å›æœ¬åœ°ä¿¡æ¯
   # ç±»ä¼¼äºdiscoveryå“åº”
   ```

---

### æˆå‘˜ä¸ƒï¼šå­™è¿è½© - ä¸€å¯¹ä¸€æ¶ˆæ¯ä¼ è¾“ â­â­

**æ–‡ä»¶**ï¼š`src/core/message_p2p.py`

**éœ€è¦å®ç°çš„å‡½æ•°**ï¼š
1. `send_p2p_message(receiver, content)`
   ```python
   message = ChatMessage(
       msg_type=MessageType.P2P_MESSAGE,
       sender=self.local_member,
       receiver=receiver,
       content=content
   )
   return self.dispatcher.send_message(
       message.to_dict(),
       receiver.ip,
       receiver.udp_port
   )
   ```

2. `handle_message(message, addr)`
   ```python
   # ååºåˆ—åŒ–å¹¶è§¦å‘ä¿¡å·
   chat_message = ChatMessage.from_dict(message)
   self.message_received.emit(chat_message)
   ```

**æµ‹è¯•æ–¹æ³•**ï¼š
- å‘é€æ¶ˆæ¯åˆ°è‡ªå·±ï¼ˆå›ç¯æµ‹è¯•ï¼‰
- å‘é€æ¶ˆæ¯åˆ°å¦ä¸€ä¸ªå®ä¾‹

---

## ğŸ“Š å¼€å‘è¿›åº¦å»ºè®®

### ç¬¬ä¸€é˜¶æ®µï¼ˆ2-3å¤©ï¼‰ï¼šåŸºç¡€æ¨¡å—
1. **æˆå‘˜ä¸€** + **æˆå‘˜äºŒ**ï¼šå®Œæˆ MessageDispatcher å¹¶æµ‹è¯•
2. **æˆå‘˜ä¸€**ï¼šå®Œæˆ NetworkDiscovery
3. **æˆå‘˜äº”**ï¼šå®Œæˆ MemberManager

### ç¬¬äºŒé˜¶æ®µï¼ˆ2-3å¤©ï¼‰ï¼šæ¶ˆæ¯åŠŸèƒ½
4. **æˆå‘˜ä¸ƒ**ï¼šå®Œæˆ MessageP2P
5. **æˆå‘˜ä¸‰**ï¼šå®Œæˆ MessageBroadcast
6. **æˆå‘˜å…­**ï¼šå®Œæˆ MemberRefresh

### ç¬¬ä¸‰é˜¶æ®µï¼ˆ3-4å¤©ï¼‰ï¼šæ–‡ä»¶ä¼ è¾“å’Œç•Œé¢
7. **æˆå‘˜å››**ï¼šå®Œæˆ FileTransfer
8. **æˆå‘˜äºŒ**ï¼šå®Œæˆ MainWindow æ•´åˆ

### ç¬¬å››é˜¶æ®µï¼ˆ2-3å¤©ï¼‰ï¼šè”è°ƒæµ‹è¯•
9. å…¨ä½“æˆå‘˜ï¼šè”åˆè°ƒè¯•ã€bugä¿®å¤ã€åŠŸèƒ½ä¼˜åŒ–

---

## âœ… æ¶æ„ä¼˜åŠ¿æ€»ç»“

| æ–¹é¢ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| **UDPç®¡ç†** | å¤šä¸ªæ¨¡å—å„è‡ªç®¡ç† | ç»Ÿä¸€ç”±Dispatcherç®¡ç† |
| **æ¶ˆæ¯æ¥æ”¶** | åªæœ‰discoveryç›‘å¬ | Dispatcherç»Ÿä¸€æ¥æ”¶åˆ†å‘ |
| **æ¨¡å—ä¾èµ–** | å¤æ‚çš„socketå…±äº« | ç®€å•çš„dispatcherä¾èµ– |
| **èŒè´£åˆ’åˆ†** | èŒè´£é‡å  | èŒè´£æ¸…æ™° |
| **å¯¹æ¥é£é™©** | é«˜ï¼ˆå®¹æ˜“å‡ºé”™ï¼‰ | ä½ï¼ˆæ¥å£æ˜ç¡®ï¼‰ |
| **å¯æµ‹è¯•æ€§** | å›°éš¾ | å®¹æ˜“ |

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

1. **æ‹‰å–æœ€æ–°ä»£ç **
2. **é˜…è¯»** `docs/æ¶æ„ä¼˜åŒ–è¯´æ˜.md`
3. **æ‰¾åˆ°è‡ªå·±çš„æ¨¡å—æ–‡ä»¶**
4. **å®ç°TODOæ ‡è®°çš„å‡½æ•°**
5. **æœ¬åœ°æµ‹è¯•**
6. **æäº¤ä»£ç **

æœ‰ä»»ä½•é—®é¢˜éšæ—¶åœ¨ç¾¤é‡Œè®¨è®ºï¼åŠ æ²¹ï¼ğŸ’ª

